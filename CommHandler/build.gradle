/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/8.7/samples
 */

plugins {
    id 'java-library'
    id 'maven-publish'
}

repositories {
    mavenLocal()
    mavenCentral()
    gradlePluginPortal()

    maven {
        url "https://nexus.library.smartgridready.ch/repository/maven-releases/"
        mavenContent {
            releasesOnly()
        }
    }
    maven {
        url "https://nexus.library.smartgridready.ch/repository/maven-snapshots/"
        mavenContent {
            snapshotsOnly()
        }
    }
}

configurations {
    integrationTestImplementation.extendsFrom testImplementation
    integrationTestRuntimeOnly.extendsFrom testRuntimeOnly
}

sourceSets {
    main.java.srcDirs = ['src/main/java']
    main.resources.srcDirs = ['src/main/resources']
    test.java.srcDirs = ['src/test/java']
    test.resources.srcDirs = ['src/test/resources']

    integrationTest {
        java.srcDir 'src/test/java'
        resources.srcDir 'src/test/resources'
        compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath
        runtimeClasspath += output + compileClasspath
    }
}

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

test {
    useJUnitPlatform() // needed to run JUnit 5 test with gradle
}

// use release versions by default (no suffix)
// spec. release date
def sgr_spec_suffix = '_2024-12-19'
def sgr_driver_suffix = ''
def easymodbus_suffix = ''
def apachehttp_suffix = ''
def hivemq_suffix = ''

// use snapshots by setting property on commandline, e.g. -Psnapshots=sgr-specification,sgr-driver-api
if (project.hasProperty("snapshots")) {
    def snapList = project.getProperty("snapshots").split(',')
    if (snapList.contains("sgr-specification")) {
        println "using snapshots of sgr-specification"
        sgr_spec_suffix = '-SNAPSHOT'
    }
    if (snapList.contains("sgr-driver-api")) {
        println "using snapshots of sgr-driver-api"
        sgr_driver_suffix = '-SNAPSHOT'
    }
    if (snapList.contains("easymodbus")) {
        println "using snapshots of easymodbus"
        easymodbus_suffix = '-SNAPSHOT'
    }
    if (snapList.contains("sgr-driver-apachehttp")) {
        println "using snapshots of sgr-driver-apachehttp"
        apachehttp_suffix = '-SNAPSHOT'
    }
    if (snapList.contains("sgr-driver-hivemq")) {
        println "using snapshots of sgr-driver-hivemq"
        hivemq_suffix = '-SNAPSHOT'
    }
}


dependencies {
    api group: 'com.smartgridready', name: 'sgr-specification', version: "2.0${sgr_spec_suffix}"
    implementation group: 'com.sun.xml.bind', name: 'jaxb-impl', version: '4.0.5'

    api group: 'com.smartgridready', name: 'sgr-driver-api', version: "2.1.0${sgr_driver_suffix}"
    testRuntimeOnly group: 'com.smartgridready', name: 'easymodbus', version: "2.1.0${easymodbus_suffix}"
    testRuntimeOnly group: 'com.smartgridready', name: 'sgr-driver-apachehttp', version: "2.0.0${apachehttp_suffix}"
    testRuntimeOnly group: 'com.smartgridready', name: 'sgr-driver-hivemq', version: "2.0.0${hivemq_suffix}"

    api group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.16.0'
    implementation group: 'io.burt', name: 'jmespath-core', version: '0.5.1'
    implementation group: 'io.burt', name: 'jmespath-jackson', version: '0.5.1'
    implementation group: 'commons-io', name: 'commons-io', version: '2.15.1'
    implementation group: 'org.apache.commons', name: 'commons-lang3', version: '3.14.0'
    implementation group: 'jakarta.annotation', name: 'jakarta.annotation-api', version: '2.1.1'
    api group: 'io.vavr', name: 'vavr', version: '0.10.5'

    api group: 'io.reactivex.rxjava3', name: 'rxjava', version: '3.1.5'

    implementation group: 'org.slf4j', name: 'slf4j-api', version: '2.0.10'

    implementation "org.mapstruct:mapstruct:1.6.0"
    annotationProcessor "org.mapstruct:mapstruct-processor:1.6.0"

    testImplementation group: 'org.apache.logging.log4j', name: 'log4j-core', version: '2.19.0'
    testImplementation group: 'org.apache.logging.log4j', name: 'log4j-api', version: '2.19.0'
    testImplementation group: 'org.apache.logging.log4j', name: 'log4j-slf4j2-impl', version: '2.19.0'

    testImplementation group: 'org.yaml', name: 'snakeyaml', version: '1.27'
    testImplementation group: 'org.mockito', name: 'mockito-core', version: '5.12.0'
    testImplementation group: 'org.mockito', name: 'mockito-junit-jupiter', version: '5.12.0'
    testImplementation group: 'org.mockito', name: 'mockito-inline', version: '5.2.0'
    testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-params', version: '5.10.2'

    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.2'

    testImplementation group: 'org.awaitility', name: 'awaitility', version: '4.2.0'
}

test {
    useJUnitPlatform()
    filter {
        excludeTestsMatching("com.smartgridready.communicator.modbus.integrationtest.*")
    }
    // this workaround is required to run some tests under JDKs > 17.
    // otherwise EqualsBuilder.reflectionEquals(...) may fail due to inaccessible fields, e.g. serialVersionUID.
    doFirst {
        jvmArgs("--add-opens", "java.base/java.util=ALL-UNNAMED")
    }
}

jar {
    exclude('log4j2.xml')
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

def integrationTestTask = tasks.register('integrationTest', Test) {
    description = 'Runs integration tests.'
    group = 'verification'
    useJUnitPlatform()

    testClassesDirs = sourceSets.integrationTest.output.classesDirs
    classpath = sourceSets.integrationTest.runtimeClasspath

    setTestNameIncludePatterns(['com.smartgridready.communicator.modbus.integrationtest.*'])

    shouldRunAfter(tasks.named('build'))
}


publishing {
    java {
        withSourcesJar()
    }

    repositories {
        maven {
            name = "Nexus"

            if (rootProject.version.toString().contains('SNAPSHOT')) {
                url = uri("https://nexus.library.smartgridready.ch/repository/maven-snapshots/")
            } else {
                url = uri("https://nexus.library.smartgridready.ch/repository/maven-releases")
            }

            credentials {
                username = findProperty("nexus.username")
                password = findProperty("nexus.password")
            }
        }

    }

    publications {
        mavenJava(MavenPublication) {
            groupId = 'com.smartgridready'
            artifactId = 'sgr-commhandler'

            from components.java
        }
    }
}
